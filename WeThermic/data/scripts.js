var cssFile='style_theme_clair.css';var largeurMoyVent=180;var largeurMoyTemp=180;var showWind=true;var showT1=true;var showT2=false;var showPressU=true;var showPressL=false;var showPressGrid=false;var netDevURL='http://192.168.1.107';var couleurVent='rgb(0, 0, 160)';var couleurFillVent='rgba(0, 0, 160, 0.3)';var couleurMoyVent='rgb(0, 0, 200)';var couleurPression='rgb(0, 80, 120)';var couleurFillPression='rgba(0, 80, 120, 0.2)';var couleurMoyPres='rgb(0, 80, 80)';var couleurTempBmp180='rgb(0, 150, 0)';var couleurMoyBmp180='rgb(0, 127, 0)';var couleurTempCtn='rgb(230, 0, 0)';var couleurFillCtn='rgba(230, 0, 0, 0.2)';var couleurMoyCtn='rgb(200, 30, 30)';var couleurGrid='rgb(187, 229, 229)';var histVentData=new Array();var histVentMoy=new Array();var vent=0.0;var histTempCtn=new Array();var histTCtnMoy=new Array();var tempctn=0.0;var ctnSuggestedMax=0.0;var ctnSuggestedMin=0.0;var histBmp180Data=new Array();histBmp180Moy=new Array();var tempBmp180=0.0;var histPression=new Array();var histPresMoy=new Array();var pression=0.0;var pSuggestedMax=0.0;var pSuggestedMin=0.0;tblVents=new Array(largeurMoyVent);var tblVentsIdx=0;var largeurVentFull=false;var ventTotal=0.0;var ventMoyen=0.0;tblPress=new Array(largeurMoyVent);var tblPressIdx=0;var largeurPresFull=false;var presTotal=0.0;var presMoyen=0.0;var largDouxPres=8;tblPresDoux=new Array(largDouxPres);var tblPresDouxIdx=0;var tblPresFull=false;var presDouxTotal=0.0;tblTemp=new Array(largeurMoyTemp);var tblTempIdx=0;var largeurTempFull=false;var bmp180Total=0.0;var bmp180Moyen=0.0;tblCtn=new Array(largeurMoyTemp);var ctnTotal=0.0;var ctnMoyen=0.0;var isFullScreen=false;var apConfigChange=false;var attenteOK=false;async function index_onload(){var cssPref=localStorage.getItem("cssFile");if(cssPref!==null){cssFile=cssPref;}
if(cssFile=='style_theme_sombre.css'){document.getElementById("sombre").checked=true;}else{document.getElementById("clair").checked=true;}
loadStyle();var moyPref=localStorage.getItem("largeurMoyVent");if(moyPref!==null){largeurMoyVent=Number(moyPref);}
moyPref=localStorage.getItem("largeurMoyTemp");if(moyPref!==null){largeurMoyTemp=Number(moyPref);}
document.getElementById("lMoyVent").value=largeurMoyVent/60;inputLargeurVent();document.getElementById("lMoyTemp").value=largeurMoyTemp/60;inputLargeurTemp();var visiPref=localStorage.getItem("showWind");if(visiPref!==null){showWind=visiPref==="true";}
var visiPref=localStorage.getItem("showT1");if(visiPref!==null){showT1=visiPref==="true";}
var visiPref=localStorage.getItem("showT2");if(visiPref!==null){showT2=visiPref==="true";}
var visiPref=localStorage.getItem("showPressU");if(visiPref!==null){showPressU=visiPref==="true";}
var visiPref=localStorage.getItem("showPressL");if(visiPref!==null){showPressL=visiPref==="true";}
var visiPref=localStorage.getItem("showPressGrid");if(visiPref!==null){showPressGrid=visiPref==="true";}
document.getElementById("showWind").checked=showWind;document.getElementById("showT1").checked=showT1;document.getElementById("showT2").checked=showT2;document.getElementById("showPressU").checked=showPressU;document.getElementById("showPressL").checked=showPressL;document.getElementById("showPressGrid").checked=showPressGrid;height=window.innerHeight;width=window.innerWidth;document.getElementById("lapage").style.height=height+"px";document.getElementById("lapage").style.width=width+"px";if(location.protocol=='file:'){XMLHttpRequest_get(netDevURL+"/getversion");}else{XMLHttpRequest_get("/getversion");}
attenteOK=false;if(location.protocol=='file:'){XMLHttpRequest_get(netDevURL+"/history");}else{XMLHttpRequest_get("/history");}
while(!attenteOK){await sleep(100);}
attenteOK=false;ctnSuggestedMax=ctnMoyen+1.5;ctnSuggestedMin=ctnMoyen-0.25;pSuggestedMax=pression+0.5;pSuggestedMin=pression-0.05;var ventData={datasets:[{cubicInterpolationMode:'default',data:histVentData,fill:{target:'origin',above:couleurFillVent,below:couleurFillVent},borderColor:couleurVent,borderWidth:2,order:2,tension:0.4},{cubicInterpolationMode:'default',data:histVentMoy,fill:false,borderColor:couleurMoyVent,borderWidth:2,order:1,tension:0.4},{cubicInterpolationMode:'default',data:histPression,fill:{target:'origin',above:couleurFillPression,below:couleurFillPression},borderColor:couleurPression,borderWidth:1,order:5,tension:0.4,yAxisID:'y1'},{cubicInterpolationMode:'default',data:histPresMoy,fill:false,borderColor:couleurMoyPres,borderWidth:2,order:4,tension:0.4,yAxisID:'y1'}]};var ventOptions={plugins:{legend:{display:false}},elements:{point:{radius:0}},scales:{x:{type:'realtime',realtime:{duration:300000,refresh:500,delay:250,frameRate:20,onRefresh:chart=>{chart.data.datasets[0].data.push({x:Date.now(),y:vent});chart.data.datasets[1].data.push({x:Date.now(),y:ventMoyen});chart.data.datasets[2].data.push({x:Date.now(),y:pression});chart.data.datasets[3].data.push({x:Date.now(),y:presMoyen});}},ticks:{display:true},grid:{color:couleurGrid}},y:{type:'linear',beginAtZero:true,suggestedMax:5,ticks:{color:couleurVent},grid:{color:couleurGrid}},y1:{type:'linear',beginAtZero:false,display:true,position:'right',suggestedMax:pSuggestedMax,suggestedMin:pSuggestedMin,ticks:{color:couleurPression},grid:{color:couleurGrid}}},responsive:true,maintainAspectRatio:false};var tempData={datasets:[{cubicInterpolationMode:'default',data:histTempCtn,fill:{target:'origin',above:couleurFillCtn,below:couleurFillCtn},borderColor:couleurTempCtn,borderWidth:2,order:1,tension:0.4,yAxisID:'y'},{cubicInterpolationMode:'default',data:histTCtnMoy,fill:false,borderColor:couleurMoyCtn,borderWidth:3,order:2,tension:0.4,yAxisID:'y'},{cubicInterpolationMode:'default',data:histBmp180Data,fill:false,borderColor:couleurTempBmp180,borderWidth:2,order:3,tension:0.4,yAxisID:'y'},{cubicInterpolationMode:'default',data:histBmp180Moy,fill:false,borderColor:couleurMoyBmp180,borderWidth:3,order:4,tension:0.4,yAxisID:'y'},{cubicInterpolationMode:'default',data:histPression,fill:{target:'origin',above:couleurFillPression,below:couleurFillPression},borderColor:couleurPression,borderWidth:1,order:5,tension:0.4,yAxisID:'y1'},{cubicInterpolationMode:'default',data:histPresMoy,fill:false,borderColor:couleurMoyPres,borderWidth:2,order:4,tension:0.4,yAxisID:'y1'}]};var tempOptions={plugins:{legend:{display:false}},elements:{point:{radius:0}},scales:{x:{type:'realtime',realtime:{duration:300000,refresh:500,delay:250,frameRate:50,onRefresh:chart=>{chart.data.datasets[0].data.push({x:Date.now(),y:tempctn});chart.data.datasets[1].data.push({x:Date.now(),y:ctnMoyen});chart.data.datasets[2].data.push({x:Date.now(),y:tempBmp180});chart.data.datasets[3].data.push({x:Date.now(),y:bmp180Moyen});chart.data.datasets[4].data.push({x:Date.now(),y:pression});chart.data.datasets[5].data.push({x:Date.now(),y:presMoyen});}},ticks:{display:true},grid:{color:couleurGrid}},y:{type:'linear',beginAtZero:false,display:true,position:'left',suggestedMax:ctnSuggestedMax,suggestedMin:ctnSuggestedMin,ticks:{color:couleurTempCtn},grid:{color:couleurGrid}},y1:{type:'linear',beginAtZero:false,display:true,position:'right',suggestedMax:pSuggestedMax,suggestedMin:pSuggestedMin,ticks:{color:couleurPression},grid:{color:couleurGrid}}},responsive:true,maintainAspectRatio:false};Window.graphVent=new Chart(document.getElementById('graphVent'),{type:'line',data:ventData,options:ventOptions});Window.graphTemp=new Chart(document.getElementById('graphTemp'),{type:'line',data:tempData,options:tempOptions});Window.graphVent.setDatasetVisibility(0,false);Window.graphVent.setDatasetVisibility(1,false);Window.graphVent.setDatasetVisibility(2,false);Window.graphTemp.setDatasetVisibility(0,false);Window.graphTemp.setDatasetVisibility(1,false);Window.graphTemp.setDatasetVisibility(2,false);Window.graphTemp.setDatasetVisibility(3,false);Window.graphTemp.setDatasetVisibility(4,false);Window.graphTemp.setDatasetVisibility(5,false);Window.graphTemp.update();visuCourbes();appliqueTheme();if(location.protocol=='file:'){setTimeout(function(){XMLHttpRequest_get(netDevURL+"/getvalues")},500);}else{setTimeout(function(){XMLHttpRequest_get("/getvalues")},500);}
var attente=document.getElementById("attente0")
attente.classList.add("noshow");}
function loadStyle(){var head=document.getElementsByTagName('head')[0];var style=document.createElement('link')
style.id='cssTheme';style.rel='stylesheet';style.type='text/css';style.href=cssFile;head.append(style);}
function echelleTemperature(scaleTemp){var scaleMin=document.getElementById("scaleMin");var scaleMax=document.getElementById("scaleMax");if(scaleTemp==0){suggestedMax=ctnMoyen+3;suggestedMin=ctnMoyen-0.5;}else if(scaleTemp==1){suggestedMax=ctnMoyen+2;suggestedMin=ctnMoyen-0.25;}else if(scaleTemp==2){suggestedMax=ctnMoyen+1;suggestedMin=ctnMoyen-0.125;}else if(scaleTemp==3){suggestedMax=ctnMoyen;suggestedMin=ctnMoyen;}else if(scaleTemp==-1){suggestedMax=scaleMax.value;suggestedMin=scaleMin.value;}
scaleMin.value=suggestedMin;scaleMax.value=suggestedMax;Window.graphTemp.options.scales['y'].suggestedMax=suggestedMax;Window.graphTemp.options.scales['y'].suggestedMin=suggestedMin;}
function recalePression(){Window.graphTemp.options.scales['y1'].suggestedMax=pression+0.5;Window.graphTemp.options.scales['y1'].suggestedMin=pression;Window.graphTemp.update();}
function XMLHttpRequest_get(requette){var heure=document.getElementById("heure");if(heure!=null){var now=new Date(Date.now());heure.textContent=now.getHours()+":"+now.getMinutes()+":"+now.getSeconds()+"."+now.getMilliseconds();}
var xhttp=new XMLHttpRequest();xhttp.onreadystatechange=function(){if(xhttp.readyState==4){if((xhttp.status==200)||(xhttp.status==0)){XMLHttpResult(requette,xhttp.responseXML,xhttp.responseText);}else{alert("XMLHttpRequest_get("+requette+") : Error "+xhttp.status);}}};xhttp.open("GET",requette,true);xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhttp.send();}
function XMLHttpResult(requette,xml,text){if(xml!=null){if((requette=="/getversion")||(requette==netDevURL+"/getversion")){var version_string=xml.getElementsByTagName("string")[0].childNodes[0].nodeValue;var doc_version=document.getElementById("version");doc_version.textContent=version_string;}else if((requette=="/history")||(requette==netDevURL+"/history")){graphHistoryintegration(xml);}else if((requette=="/getvalues")||(requette==netDevURL+"/getvalues")){vent=Number(xml.getElementsByTagName("v")[0].childNodes[0].nodeValue);calculMoyenneVent();var doc_vent=document.getElementById("valeurVent");doc_vent.innerHTML='<span class="couleurMoyVent">moy = '+Number.parseFloat(ventMoyen).toFixed(1)+'</span>&nbsp;';doc_vent.innerHTML+='<span class="couleurVent">inst = '+Number.parseFloat(vent).toFixed(1).padStart(4,' ')+' m/s</span>';var newCtn=Number(xml.getElementsByTagName("c")[0].childNodes[0].nodeValue);if(Math.abs(newCtn-tempctn)<3){tempctn=newCtn;}else{tempctn=ctnMoyen;}
tempBmp180=Number(xml.getElementsByTagName("b")[0].childNodes[0].nodeValue);calculMoyenneTemperature();var showT1=document.getElementById("showT1").checked;var doc_temp=document.getElementById("valeurTemp");doc_temp.innerHTML=""
if(showT2){doc_temp.innerHTML+='<span class="couleurMoyBmp180">moy = '+Number.parseFloat(bmp180Moyen).toFixed(1)+'</span>&nbsp;';doc_temp.innerHTML+='<span class="couleurTempBmp180">inst = '+Number.parseFloat(tempBmp180).toFixed(2)+'°C</span><br />';}
if(showT1){doc_temp.innerHTML+='<span class="couleurMoyCtn">moy = '+Number.parseFloat(ctnMoyen).toFixed(1)+'</span>&nbsp;';doc_temp.innerHTML+='<span class="couleurTempCtn">inst = '+Number.parseFloat(tempctn).toFixed(2)+'°C</span>'}
pression=calculPressionDouce(Number(xml.getElementsByTagName("p")[0].childNodes[0].nodeValue));calculMoyennePres();var doc_press=document.getElementById("valeurPress");doc_press.innerHTML='<span class="couleurPression">'+Number.parseFloat(pression).toFixed(1)+"hPa</span>";}else if((requette=="/getnetworks")||(requette==netDevURL+"/getnetworks")){setNetworkList(xml);attenteOK=true;}else if(requette=="/wificonnect"){result=xml.getElementsByTagName("result")[0].childNodes[0].nodeValue;if(result=="OK"){alert("Connexion OK.");}else{alert("Connexion error: \n"+result);}}else if((requette=="/getapconfig")||(requette==netDevURL+"/getapconfig")){var ssid=xml.getElementsByTagName("ssid")[0].textContent;var pwd=xml.getElementsByTagName("pwd")[0].textContent;var apSSID=document.getElementById('apSSID');var apPwd1=document.getElementById('apPwd1');apSSID.value=ssid;apPwd1.value=pwd;apConfigChange=false;inputConfigAP();}}
if((requette=="/getvalues")||(requette==netDevURL+"/getvalues")){autoRefresh();}}
function graphHistoryintegration(xml){var flagDebut=false;tX=Date.now();tX=tX-(5*60*1000)
hist=xml.getElementsByTagName("h");for(const h of hist){pression=calculPressionDouce(Number(h.getElementsByTagName("p")[0].childNodes[0].nodeValue));if(pression!=0){calculMoyennePres();vent=Number(h.getElementsByTagName("v")[0].childNodes[0].nodeValue);calculMoyenneVent();var newCtn=Number(h.getElementsByTagName("c")[0].childNodes[0].nodeValue);if(!(flagDebut)){tempctn=newCtn;flagDebut=true;}else if(Math.abs(newCtn-tempctn)<3){tempctn=newCtn;}else{tempctn=ctnMoyen;}
tempBmp180=Number(h.getElementsByTagName("b")[0].childNodes[0].nodeValue);calculMoyenneTemperature();histVentData.push({x:tX,y:vent});histVentMoy.push({x:tX,y:ventMoyen});histTempCtn.push({x:tX,y:tempctn});histTCtnMoy.push({x:tX,y:ctnMoyen});histBmp180Data.push({x:tX,y:tempBmp180});histBmp180Moy.push({x:tX,y:bmp180Moyen});histPression.push({x:tX,y:pression});histPresMoy.push({x:tX,y:presMoyen});}
tX+=500}
attenteOK=true;}
function autoRefresh(){if(location.protocol=='file:'){setTimeout(function(){XMLHttpRequest_get(netDevURL+"/getvalues")},500);}else{setTimeout(function(){XMLHttpRequest_get("/getvalues")},500);}}
function calculMoyenneVent(){if(isNaN(tblVents[tblVentsIdx])){tblVents[tblVentsIdx]=0}
ventTotal=ventTotal-tblVents[tblVentsIdx];tblVents[tblVentsIdx]=vent;ventTotal=ventTotal+tblVents[tblVentsIdx];tblVentsIdx=tblVentsIdx+1;if(tblVentsIdx>=largeurMoyVent){tblVentsIdx=0;largeurVentFull=true;}
if(largeurVentFull){ventMoyen=Math.round(ventTotal/largeurMoyVent*10)/10;}else{ventMoyen=Math.round(ventTotal/tblVentsIdx*10)/10;}}
function calculMoyennePres(){if(isNaN(tblPress[tblPressIdx])){tblPress[tblPressIdx]=0}
presTotal=presTotal-tblPress[tblPressIdx];tblPress[tblPressIdx]=pression;presTotal=presTotal+tblPress[tblPressIdx];tblPressIdx=tblPressIdx+1;if(tblPressIdx>=largeurMoyVent){tblPressIdx=0;largeurPresFull=true;}
if(largeurVentFull){presMoyen=Math.round(presTotal/largeurMoyVent*100)/100;}else{presMoyen=Math.round(presTotal/tblPressIdx*100)/100;}}
function calculPressionDouce(pBrute){var presDouxMoyen=0.0;if(pBrute>0){if(isNaN(tblPresDoux[tblPresDouxIdx])){tblPresDoux[tblPresDouxIdx]=0}
presDouxTotal=presDouxTotal-tblPresDoux[tblPresDouxIdx];tblPresDoux[tblPresDouxIdx]=pBrute;presDouxTotal=presDouxTotal+tblPresDoux[tblPresDouxIdx];tblPresDouxIdx=tblPresDouxIdx+1;if(tblPresDouxIdx>=largDouxPres){tblPresDouxIdx=0;tblPresFull=true;}
if(tblPresFull){presDouxMoyen=presDouxTotal/largDouxPres;}else{presDouxMoyen=presDouxTotal/tblPresDouxIdx;}
return presDouxMoyen;}else{return 0.0;}}
function calculMoyenneTemperature(){if(isNaN(tblTemp[tblTempIdx])){tblTemp[tblTempIdx]=0
tblCtn[tblTempIdx]=0}
bmp180Total=bmp180Total-tblTemp[tblTempIdx];ctnTotal=ctnTotal-tblCtn[tblTempIdx];tblTemp[tblTempIdx]=tempBmp180;tblCtn[tblTempIdx]=tempctn;bmp180Total=bmp180Total+tblTemp[tblTempIdx];ctnTotal=ctnTotal+tblCtn[tblTempIdx];tblTempIdx=tblTempIdx+1;if(tblTempIdx>=largeurMoyTemp){tblTempIdx=0;largeurTempFull=true;}
if(largeurTempFull){bmp180Moyen=Math.round(bmp180Total/largeurMoyTemp*100)/100;ctnMoyen=Math.round(ctnTotal/largeurMoyTemp*100)/100;}else{bmp180Moyen=Math.round(bmp180Total/tblTempIdx*100)/100;ctnMoyen=Math.round(ctnTotal/tblTempIdx*100)/100;}}
function changeSettings(){var dialog=document.getElementById("settingsDialog")
dialog.classList.remove("noshow");var attente=document.getElementById("attente0")
attente.classList.remove("noshow");var scaleMin=document.getElementById("scaleMin");var scaleMax=document.getElementById("scaleMax");var valeur=Window.graphTemp.scales['y'].max;scaleMax.value=valeur;var valeur=Window.graphTemp.scales['y'].min;scaleMin.value=valeur;getAPconfig();get_networks();}
function closeSettings(){var dialog=document.getElementById('settingsDialog')
dialog.classList.add("noshow");}
function changeTheme(theme){if((theme=='clair')&&(cssFile=='style_theme_sombre.css')){cssFile='style_theme_clair.css';themeStyle=document.getElementById('cssTheme');themeStyle.href=cssFile;}else if((theme=='sombre')&&(cssFile=='style_theme_clair.css')){cssFile='style_theme_sombre.css';themeStyle=document.getElementById('cssTheme');themeStyle.href=cssFile;}
localStorage.setItem("cssFile",cssFile);appliqueTheme();}
function appliqueTheme(){setTimeout(()=>{var style=getComputedStyle(document.body);couleurVent=style.getPropertyValue('--couleurVent');couleurFillVent=style.getPropertyValue('--couleurFillVent');couleurMoyVent=style.getPropertyValue('--couleurMoyVent');couleurPression=style.getPropertyValue('--couleurPression');couleurFillPression=style.getPropertyValue('--couleurFillPression');couleurMoyPres=style.getPropertyValue('--couleurMoyPres');couleurTempCtn=style.getPropertyValue('--couleurTempCtn');couleurFillCtn=style.getPropertyValue('--couleurFillCtn');couleurMoyCtn=style.getPropertyValue('--couleurMoyCtn');couleurTempBmp180=style.getPropertyValue('--couleurTempBmp180');couleurMoyBmp180=style.getPropertyValue('--couleurMoyBmp180');couleurGrid=style.getPropertyValue('--couleurGrid');Window.graphVent.options.scales['y'].ticks.color=couleurVent;Window.graphVent.data.datasets[0].borderColor=couleurVent;Window.graphVent.data.datasets[0].fill.above=couleurFillVent;Window.graphVent.data.datasets[0].fill.below=couleurFillVent;Window.graphVent.data.datasets[1].borderColor=couleurMoyVent;Window.graphVent.options.scales['y1'].ticks.color=couleurPression;Window.graphVent.data.datasets[2].borderColor=couleurPression;Window.graphVent.data.datasets[2].fill.above=couleurFillPression;Window.graphVent.data.datasets[2].fill.below=couleurFillPression;Window.graphVent.data.datasets[3].borderColor=couleurMoyPres;Window.graphVent.options.scales['x'].grid.color=couleurGrid;Window.graphVent.options.scales['y'].grid.color=couleurGrid;Window.graphVent.options.scales['y1'].grid.color=couleurGrid;Window.graphTemp.options.scales['y'].ticks.color=couleurTempCtn;Window.graphTemp.data.datasets[0].borderColor=couleurTempCtn;Window.graphTemp.data.datasets[0].fill.above=couleurFillCtn;Window.graphTemp.data.datasets[0].fill.below=couleurFillCtn;Window.graphTemp.data.datasets[1].borderColor=couleurMoyCtn;Window.graphTemp.data.datasets[2].borderColor=couleurTempBmp180;Window.graphTemp.data.datasets[3].borderColor=couleurMoyBmp180;Window.graphTemp.options.scales['y1'].ticks.color=couleurPression;Window.graphTemp.data.datasets[4].borderColor=couleurPression;Window.graphTemp.data.datasets[4].fill.above=couleurFillPression;Window.graphTemp.data.datasets[4].fill.below=couleurFillPression;Window.graphTemp.options.scales['x'].grid.color=couleurGrid;Window.graphTemp.options.scales['y'].grid.color=couleurGrid;Window.graphTemp.options.scales['y1'].grid.color=couleurGrid;},500);}
function visuCourbes(){newValue=document.getElementById("showWind").checked;if(newValue!=showWind){showWind=newValue;localStorage.setItem("showWind",showWind);}
Window.graphVent.setDatasetVisibility(0,showWind);Window.graphVent.setDatasetVisibility(1,showWind);Window.graphVent.options.scales['y'].ticks.display=showWind;Window.graphVent.options.scales['y'].grid.display=showWind;newValue=document.getElementById("showPressU").checked;if(newValue!=showPressU){showPressU=newValue;localStorage.setItem("showPressU",showPressU);}
Window.graphVent.setDatasetVisibility(2,showPressU);Window.graphVent.setDatasetVisibility(3,showPressU);newValue=document.getElementById("showT1").checked;if(newValue!=showT1){showT1=newValue;localStorage.setItem("showT1",showT1);}
Window.graphTemp.setDatasetVisibility(0,showT1);Window.graphTemp.setDatasetVisibility(1,showT1);newValue=document.getElementById("showPressL").checked;if(newValue!=showPressL){showPressL=newValue;localStorage.setItem("showPressL",showPressL);}
Window.graphTemp.setDatasetVisibility(4,showPressL);Window.graphTemp.setDatasetVisibility(5,showPressL);newValue=document.getElementById("showT2").checked;if(newValue!=showT2){showT2=newValue;localStorage.setItem("showT2",showT2.toString());}
Window.graphTemp.setDatasetVisibility(2,showT2);Window.graphTemp.setDatasetVisibility(3,showT2);newValue=document.getElementById("showPressGrid").checked;if(newValue!=showPressGrid){showPressGrid=newValue;localStorage.setItem("showPressGrid",showPressGrid);}
Window.graphVent.options.scales['y1'].ticks.display=showPressGrid;Window.graphVent.options.scales['y1'].grid.display=showPressGrid;Window.graphTemp.options.scales['y1'].ticks.display=showPressGrid;Window.graphTemp.options.scales['y1'].grid.display=showPressGrid;}
async function get_networks(){var divNetworkTable=document.getElementById("networkTable");divNetworkTable.innerHTML="";var ssidActuel=document.getElementById("ssidActuel");ssidActuel.value="";var ipActuel=document.getElementById("ipActuel");ipActuel.value="";attenteOK=false;if(location.protocol=='file:'){XMLHttpRequest_get(netDevURL+"/getnetworks");}else{XMLHttpRequest_get("/getnetworks");}
while(!attenteOK){await sleep(100);}
attenteOK=false;}
function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms));}
function setNetworkList(xml){var htmlNetworkTable="";var tmpSSID="";var tmpChannel=0;var tmpRSSI="";var tmpCrypt="";var tmpPasswd="";var tmpImgSignal="";var divNetworkTable=document.getElementById("networkTable");htmlNetworkTable+="  <table class=\"netTables\">\n";htmlNetworkTable+="    <thead>\n";htmlNetworkTable+="      <tr>\n";htmlNetworkTable+="        <th>&nbsp;</th>\n";htmlNetworkTable+="        <th>SSID</th>\n";htmlNetworkTable+="        <th>Channel</th>\n";htmlNetworkTable+="        <th>Security</th>\n";htmlNetworkTable+="      </tr>\n";htmlNetworkTable+="    </thead>\n";htmlNetworkTable+="    <tbody>\n";var netCurrent=xml.getElementsByTagName("activeNetwork")
if(netCurrent.length==1){var ssidActuel=document.getElementById("ssidActuel");currentSSID=netCurrent[0].getElementsByTagName("SSID")[0].childNodes[0].nodeValue;ssidActuel.value=currentSSID;var ipActuel=document.getElementById("ipActuel");currentIP=netCurrent[0].getElementsByTagName("localip")[0].childNodes[0].nodeValue;ipActuel.value=currentIP;}
var netListe=xml.getElementsByTagName("network")
if(netListe.length>0){for(var i=0;i<netListe.length;i++){tmpSSID=netListe[i].getElementsByTagName("SSID")[0].textContent;tmpChannel=netListe[i].getElementsByTagName("channel")[0].textContent;tmpRSSI=netListe[i].getElementsByTagName("RSSI")[0].textContent;tmpCrypt=netListe[i].getElementsByTagName("encryption")[0].textContent;tmpPasswd=netListe[i].getElementsByTagName("knownPassword")[0].textContent;if(tmpRSSI<=-90){tmpImgSignal="images/signal0.svg";}else if((tmpRSSI>-90)&&(tmpRSSI<=-80)){tmpImgSignal="images/signal1.svg";}else if((tmpRSSI>-80)&&(tmpRSSI<=-70)){tmpImgSignal="images/signal2.svg";}else if((tmpRSSI>-70)&&(tmpRSSI<=-67)){tmpImgSignal="images/signal3.svg";}else if(tmpRSSI>-67){tmpImgSignal="images/signal4.svg";}
htmlNetworkTable+="      <tr class=\"trlink\" onclick=\"wifi_connect('"+tmpSSID+"', '"+tmpChannel+"', '"+tmpPasswd.replace("'","\\'")+"')\">\n";htmlNetworkTable+="        <td class=\"centreVertical\"><img src=\""+tmpImgSignal+"\" title=\"RSSI = "+tmpRSSI+"\" /></td>\n";htmlNetworkTable+="        <td>"+tmpSSID+"</td>\n";htmlNetworkTable+="        <td>"+tmpChannel+"</td>\n";htmlNetworkTable+="        <td>"+tmpCrypt+"</td>\n";htmlNetworkTable+="      </tr>\n";}}else{htmlNetworkTable+="      <tr>\n";htmlNetworkTable+="        <td colspan=\"4\">No network available</td>";htmlNetworkTable+="      </tr>\n";}
htmlNetworkTable+="    </tbody>\n";htmlNetworkTable+="  </table>\n";divNetworkTable.innerHTML=htmlNetworkTable;var attente=document.getElementById("attente0")
attente.classList.add("noshow");}
async function wifi_connect(SSID,channel,passwd){var pwd="";var ssid_input=document.getElementById("ssid_input");var pwd_input=document.getElementById("pwd_input");var divWait=document.getElementById("attente0");var btnConnect=document.getElementById("btnConnect");var btnAnnuler=document.getElementById("btnAnnuler");const bouton=document.getElementById('btnShowCliPasswd');var pwd_input=document.getElementById('pwd_input');if(pwd_input.type!=="password"){pwd_input.type="password";bouton.src="images/oeuil.svg"
bouton.title="Show password"}
ssid_input.value=SSID+" (ch."+channel+")";pwd_input.value=passwd.replace("\\'","'");connectOK=true;suiteOK=false;afficheDialog('dlgConnect');btnConnect.disabled=false;btnAnnuler.disabled=false;pwd_input.focus();while(!suiteOK){await sleep(100);}
suiteOK=false;if(connectOK){pwd=pwd_input.value;btnConnect.disabled=true;btnAnnuler.disabled=true;divWait.classList.remove("noshow");XMLHttpRequest_post_wificonnect(SSID,pwd,channel);setTimeout(function(){divWait.classList.add("noshow");},10000);setTimeout(function(){closeDialog('dlgConnect');},10000);}else{closeDialog('dlgConnect');btnConnect.disabled=false;btnAnnuler.disabled=false;pwd_input.value="";}}
function afficheDialog(dialog_id){var dlgMask=document.getElementById("dlgMask0");var dlgBox=document.getElementById(dialog_id);dlgMask.classList.remove("noshow");window.setTimeout(function(){dlgBox.classList.remove("masquer");},0.2);}
function closeDialog(dialog_id){var dlgMask=document.getElementById("dlgMask0");var dlgBox=document.getElementById(dialog_id);dlgBox.classList.add("masquer");window.setTimeout(function(){dlgMask.classList.add("noshow");},1);}
function connect_clique(){connectOK=true;suiteOK=true;get_networks();}
function connect_cancel(){connectOK=false;suiteOK=true;}
function connect_keyup(e){if(e.keyCode===13){document.getElementById("btnConnect").click();}else if(e.keyCode===27){document.getElementById("btnAnnuler").click();}}
function XMLHttpRequest_post_wificonnect(SSID,pwd,channel){var xhttp=new XMLHttpRequest();xhttp.onreadystatechange=function(){if(xhttp.readyState==4){if((xhttp.status==200)||(xhttp.status==0)){XMLHttpResult("/wificonnect",xhttp.responseXML,xhttp.responseText);}else{alert("XMLHttpRequest_post_wificonnect() : Error "+xhttp.status);}}};var ssid_encode=encodeURIComponent(SSID);var pwd_encode=encodeURIComponent(pwd);if(location.protocol=='file:'){xhttp.open("POST",netDevURL+"/wificonnect",true);}else{xhttp.open("POST","/wificonnect",true);}
xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhttp.send("ssid="+ssid_encode+"&pwd="+pwd_encode+"&channel="+channel);}
function deconnect_clique(){var message="";message="Do you really want to disconnect from the current network\nand clear the client WiFi settings in the balance?";if(confirm(message)){XMLHttpRequest_get("deconnexion");}
get_networks();}
function toggleFullscreen(){bouton=document.getElementById("fullScreenButton");if(!isFullScreen){openFullscreen();isFullScreen=true;bouton.innerHTML="<br />Close full screen<br />&nbsp;";}else{closeFullscreen();isFullScreen=false;bouton.innerHTML="<br />View in full screen<br />&nbsp;";}
window.scrollTo(0,0);}
function openFullscreen(){var elem=document.documentElement;if(elem.requestFullscreen){elem.requestFullscreen();}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen();}else if(elem.msRequestFullscreen){elem.msRequestFullscreen();}}
function closeFullscreen(){if(document.exitFullscreen){document.exitFullscreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}}
function fullscreenchanged(event){height=window.innerHeight;width=window.innerWidth;document.getElementById("lapage").style.height=height+"px";document.getElementById("lapage").style.width=width+"px";}
document.addEventListener("fullscreenchange",fullscreenchanged);function inputLargeurVent(){var lbl=document.getElementById("valMoyVent");var newVal=document.getElementById("lMoyVent").value;secondes=newVal*30;lbl.innerText=new Date(secondes*1000).toISOString().substring(15,19);}
function changeLargeurVent(){var newVal=document.getElementById("lMoyVent").value;largeurMoyVent=newVal*60;delete tblVents;tblVents=new Array(largeurMoyVent);tblVentsIdx=0
ventTotal=0.0;ventMoyen=0.0;Window.graphVent.data.datasets[1].data=[];localStorage.setItem("largeurMoyVent",largeurMoyVent);}
function inputLargeurTemp(){var lbl=document.getElementById("valMoyTemp");var newVal=document.getElementById("lMoyTemp").value;secondes=newVal*30;lbl.innerText=new Date(secondes*1000).toISOString().substring(15,19);}
function changeLargeurTemp(){var newVal=document.getElementById("lMoyTemp").value
largeurMoyTemp=newVal*60;delete tblTemp;tblTemp=new Array(largeurMoyTemp);tblTempIdx=0;largeurTempFull=false;bmp180Total=0.0;bmp180Moyen=0.0;delete tblCtn;tblCtn=new Array(largeurMoyTemp);ctnTotal=0.0;ctnMoyen=0.0;Window.graphTemp.data.datasets[1].data=[];Window.graphTemp.data.datasets[3].data=[];localStorage.setItem("largeurMoyTemp",largeurMoyTemp);}
function getAPconfig(){if(location.protocol=='file:'){XMLHttpRequest_get(netDevURL+"/getapconfig");}else{XMLHttpRequest_get("/getapconfig");}}
function toogleShowPasswd(dest){if(dest=="ap"){const bouton=document.getElementById('btnShowPasswd');var apPwd1=document.getElementById('apPwd1');var apPwd2=document.getElementById('apPwd2');if(apPwd1.type==="password"){apPwd1.type="text";apPwd2.type="text";bouton.src="images/oeuil-barre.svg"
bouton.title="Hide password"}else{apPwd1.type="password";apPwd2.type="password";bouton.src="images/oeuil.svg"
bouton.title="Show password"}}else{const bouton=document.getElementById('btnShowCliPasswd');var pwd_input=document.getElementById('pwd_input');if(pwd_input.type==="password"){pwd_input.type="text";bouton.src="images/oeuil-barre.svg"
bouton.title="Hide password"}else{pwd_input.type="password";bouton.src="images/oeuil.svg"
bouton.title="Show password"}}}
function inputConfigAP(){var apSSID=document.getElementById('apSSID');var apPwd1=document.getElementById('apPwd1');var apPwd2=document.getElementById('apPwd2');var btnValideAP=document.getElementById('btnValideAP');if((apPwd1.value==apPwd2.value)&&((apPwd1.value.length==0)||(apPwd1.value.length>=8))&&apConfigChange){btnValideAP.src="images/valid.svg";btnValideAP.style.cursor="pointer";}else{btnValideAP.src="images/valid-disable.svg";btnValideAP.style.cursor="default";}}
function updateAPconfig(){var apSSID=document.getElementById('apSSID');var apPwd1=document.getElementById('apPwd1');var apPwd2=document.getElementById('apPwd2');if((apPwd1.value==apPwd2.value)&&((apPwd1.value.length==0)||(apPwd1.value.length>=8))&&apConfigChange){var xhttp=new XMLHttpRequest();xhttp.onreadystatechange=function(){if(xhttp.readyState==4){if((xhttp.status==200)||(xhttp.status==0)){alert("updateAPconfig():\n"+xhttp.responseText);}else{alert("updateAPconfig() : Error "+xhttp.status);}}};var ssid_encode=encodeURIComponent(apSSID.value);var pwd_encode=encodeURIComponent(apPwd1.value);if(location.protocol=='file:'){xhttp.open("POST",netDevURL+"/setapconfig",true);}else{xhttp.open("POST","/setapconfig",true);}
xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhttp.send("ssid="+ssid_encode+"&pwd="+pwd_encode);}else{alert("Entered passwords are not identical!");}}
function resetSettings(){localStorage.clear();window.location.reload();}
function reboot(){if(confirm("Reboot the weather station?")==true){if(location.protocol=='file:'){XMLHttpRequest_get(netDevURL+"/reboot");}else{XMLHttpRequest_get("/reboot");}}}